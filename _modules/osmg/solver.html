
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>osmg.solver &#8212; osmg 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for osmg.solver</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Defines Analysis objects.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#</span>
<span class="c1">#   _|_|      _|_|_|  _|      _|    _|_|_|</span>
<span class="c1"># _|    _|  _|        _|_|  _|_|  _|</span>
<span class="c1"># _|    _|    _|_|    _|  _|  _|  _|  _|_|</span>
<span class="c1"># _|    _|        _|  _|      _|  _|    _|</span>
<span class="c1">#   _|_|    _|_|_|    _|      _|    _|_|_|</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># https://github.com/ioannis-vm/OpenSees_Model_Generator</span>

<span class="c1"># pylint: disable=no-member</span>
<span class="c1"># pylint: disable=dangerous-default-value</span>
<span class="c1"># pylint: disable=unused-argument</span>
<span class="c1"># pylint: disable=multiple-statements</span>
<span class="c1"># flake8: noqa: E701  # I like multiple statements on one line, sometimes.</span>
<span class="c1"># mypy: disable-error-code=&quot;attr-defined&quot;</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">perf_counter</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.typing</span> <span class="k">as</span> <span class="nn">npt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">openseespy.opensees</span> <span class="k">as</span> <span class="nn">ops</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">.load_case</span> <span class="kn">import</span> <span class="n">LoadCase</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">.ops</span> <span class="kn">import</span> <span class="n">element</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">common</span>
<span class="kn">from</span> <span class="nn">.graphics</span> <span class="kn">import</span> <span class="n">general_2d</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">transformations</span>
<span class="kn">from</span> <span class="nn">.collections</span> <span class="kn">import</span> <span class="n">Collection</span>
<span class="kn">from</span> <span class="nn">.gen.query</span> <span class="kn">import</span> <span class="n">LoadCaseQuery</span>
<span class="kn">from</span> <span class="nn">.ops</span> <span class="kn">import</span> <span class="n">uniaxial_material</span>

<span class="n">nparr</span> <span class="o">=</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>

<span class="n">CONSTRAINTS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Transformation&quot;</span><span class="p">,)</span>
<span class="n">NUMBERER</span> <span class="o">=</span> <span class="s2">&quot;RCM&quot;</span>


<div class="viewcode-block" id="Results"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.Results">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Results</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores analysis results.</span>

<span class="sd">    Attributes:</span>
<span class="sd">      node_displacements: Displacements, stored in a dictionary. The</span>
<span class="sd">        keys correspond to the node UIDs. Each value is a dictionary,</span>
<span class="sd">        of which the keys are the analysis step. Each value of that is</span>
<span class="sd">        list containing the displacement of each DOF.</span>
<span class="sd">      node_velocities: Similar to node_displacements.</span>
<span class="sd">      node_accelerations: Similar to node_displacements.</span>
<span class="sd">      node_reactions: Similar to node displacements.</span>
<span class="sd">      element_forces: Basic forces of beamcolumn elements. The nested</span>
<span class="sd">        structure is similar to that of node_displacements.</span>
<span class="sd">      release_foce_defo: Force-deformation pairs of zerolength</span>
<span class="sd">        elements. The nested structure is similar to that of</span>
<span class="sd">        node_displacements.</span>
<span class="sd">      periods: Optional, stores the periods for modal analyses.</span>
<span class="sd">      n_steps_success: Total number of steps of the analysis.</span>
<span class="sd">      metadata: Optional metadata that depend on the type of analysis.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">node_displacements</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">node_velocities</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">node_accelerations</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">node_reactions</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">element_forces</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">nparr</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># fiber_stress_strain: Collection = field(init=False)</span>
    <span class="n">release_force_defo</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">periods</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nparr</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">n_steps_success</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_displacements</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_velocities</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_accelerations</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_reactions</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element_forces</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># self.fiber_stress_strain = Collection(self)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release_force_defo</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="AnalysisSettings"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.AnalysisSettings">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AnalysisSettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analysis settings object.</span>
<span class="sd">    Controls what will be stored and how.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">store_forces</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">store_reactions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">store_fiber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">store_release_force_defo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">specific_nodes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">pickle_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;UmfPack&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Analysis"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.Analysis">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Analysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parent analysis class.</span>

<span class="sd">    Attributes:</span>
<span class="sd">      mdl: a given model</span>
<span class="sd">      load_cases: Dictionary containing load case names and</span>
<span class="sd">        load case objects in which those load cases reside.</span>
<span class="sd">      output_directory: Where to place the results</span>
<span class="sd">        when it is requested for them to be pickled.</span>
<span class="sd">      settings: analysis settings</span>
<span class="sd">      results: analysis results</span>
<span class="sd">      logger: Logger object</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mdl</span><span class="p">:</span> <span class="n">Model</span>
    <span class="n">load_cases</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">LoadCase</span><span class="p">]</span>
    <span class="n">output_directory</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">settings</span><span class="p">:</span> <span class="n">AnalysisSettings</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">AnalysisSettings</span>
    <span class="p">)</span>
    <span class="n">results</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Results</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="Analysis.log"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.Analysis.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a message to the log file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="c1"># logger might not have been initialized yet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="Analysis.print"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.Analysis.print">[docs]</a>    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints a message to stdout.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="c1"># logger might not have been initialized yet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># initialize output directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># initialize logger</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">log_file</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span>
                <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span>
                <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y %I:%M:%S %p&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;OpenSees_Model_Generator&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">pickle_results</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specify an output directory for the results.&quot;</span><span class="p">)</span>

        <span class="c1"># initialize result collections</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">case_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">:</span>
            <span class="n">node_uids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">specific_nodes</span><span class="p">:</span>
                <span class="n">node_uids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">specific_nodes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_uids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">uid</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_all_nodes</span><span class="p">())</span>
                <span class="n">node_uids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">n</span><span class="o">.</span><span class="n">uid</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span>
                            <span class="n">case_name</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">parent_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Results</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">node_uids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_velocities</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_accelerations</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_reactions</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_forces</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">dict_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">element_forces</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">dict_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">element_forces</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">dict_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">element_forces</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_fiber</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">dict_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">element_forces</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_release_force_defo</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">dict_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ZeroLength</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">release_force_defo</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Analysis started&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_results_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pickles the results.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="si">}</span><span class="s2">/main_results.pcl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

<div class="viewcode-block" id="Analysis.read_results_from_disk"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.Analysis.read_results_from_disk">[docs]</a>    <span class="k">def</span> <span class="nf">read_results_from_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads back results from a pickle file.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="si">}</span><span class="s2">/main_results.pcl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_to_opensees_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines the model in OpenSeesPy.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialize</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">wipe</span><span class="p">()</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="s2">&quot;-ndm&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;-ndf&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># ~~~~~~~~~~~~~~~ #</span>
        <span class="c1"># Node definition #</span>
        <span class="c1"># ~~~~~~~~~~~~~~~ #</span>

        <span class="c1"># keep track of defined nodes</span>
        <span class="n">defined_nodes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">primary_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">dict_of_primary_nodes</span><span class="p">()</span>
        <span class="n">internal_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">dict_of_internal_nodes</span><span class="p">()</span>
        <span class="n">parent_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parent_node_to_lvl</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">lvl_uid</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">parent_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parent_nodes</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
            <span class="n">parent_node_to_lvl</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">lvl_uid</span>

        <span class="n">all_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">primary_nodes</span><span class="p">)</span>
        <span class="n">all_nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">internal_nodes</span><span class="p">)</span>
        <span class="n">all_nodes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parent_nodes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">all_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">defined_nodes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node already defined: </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">defined_nodes</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="c1"># restraints</span>
        <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">primary_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">restraint</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">internal_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># (this is super unusual, but who knows..)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">restraint</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">parent_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="o">*</span><span class="n">node</span><span class="o">.</span><span class="n">restraint</span><span class="p">)</span>

        <span class="c1"># lumped nodal mass</span>
        <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">all_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># retrieve osmg node mass</span>
            <span class="n">specified_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_mass</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
            <span class="c1"># replace zeros with a small mass</span>
            <span class="c1"># (to be able to capture all mode shapes)</span>
            <span class="n">specified_mass</span><span class="p">[</span><span class="n">specified_mass</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">EPSILON</span>
            <span class="c1"># verify that all mass values are non-negative</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">specified_mass</span><span class="p">[</span><span class="n">specified_mass</span> <span class="o">&lt;</span> <span class="mf">0.00</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="c1"># assign mass to the opensees node</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="o">*</span><span class="n">specified_mass</span><span class="p">)</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>
        <span class="c1"># Elastic BeamColumn element definition #</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>

        <span class="c1"># keep track of defined elements</span>
        <span class="n">defined_elements</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">elms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">dict_of_specific_element</span><span class="p">(</span>
            <span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># define line elements</span>
        <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">geomTransf</span><span class="p">(</span><span class="o">*</span><span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="o">*</span><span class="n">elm</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>
        <span class="c1"># Fiber BeamColumn element definition #</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>

        <span class="c1"># keep track of defined elements</span>
        <span class="n">defined_sections</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">defined_materials</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">elms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">define_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">defined_materials</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            A cute recursive function that defines materials with</span>
<span class="sd">            predecessors.</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># if the actual material has not been defined yet,</span>
            <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defined_materials</span><span class="p">:</span>
                <span class="k">while</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s2">&quot;predecessor&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">predecessor</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defined_materials</span>
                <span class="p">):</span>
                    <span class="c1"># define predecessor</span>
                    <span class="n">define_material</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">predecessor</span><span class="p">,</span> <span class="n">defined_materials</span><span class="p">)</span>
                <span class="c1"># and also define the actual material</span>
                <span class="n">ops</span><span class="o">.</span><span class="n">uniaxialMaterial</span><span class="p">(</span><span class="o">*</span><span class="n">mat</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>
                <span class="n">defined_materials</span><span class="p">[</span><span class="n">mat</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span>

        <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elms</span><span class="p">:</span>
            <span class="n">sec</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">section</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">sec</span><span class="o">.</span><span class="n">section_parts</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sec</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defined_sections</span><span class="p">:</span>
                <span class="n">ops</span><span class="o">.</span><span class="n">section</span><span class="p">(</span><span class="o">*</span><span class="n">sec</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>
                <span class="n">defined_sections</span><span class="p">[</span><span class="n">sec</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">sec</span>
                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">ops_material</span>
                    <span class="n">define_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">defined_materials</span><span class="p">)</span>
                    <span class="n">pieces</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">cut_into_tiny_little_pieces</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">piece</span> <span class="ow">in</span> <span class="n">pieces</span><span class="p">:</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">piece</span><span class="o">.</span><span class="n">area</span>
                        <span class="n">z_loc</span> <span class="o">=</span> <span class="n">piece</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span>
                        <span class="n">y_loc</span> <span class="o">=</span> <span class="n">piece</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span>
                        <span class="n">ops</span><span class="o">.</span><span class="n">fiber</span><span class="p">(</span><span class="n">y_loc</span><span class="p">,</span> <span class="n">z_loc</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">part</span><span class="o">.</span><span class="n">ops_material</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">beamIntegration</span><span class="p">(</span><span class="o">*</span><span class="n">elm</span><span class="o">.</span><span class="n">integration</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">geomTransf</span><span class="p">(</span><span class="o">*</span><span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="o">*</span><span class="n">elm</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>
        <span class="c1"># ZeroLength element definition #</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>

        <span class="n">elms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ZeroLength</span><span class="p">)</span>

        <span class="c1"># define zerolength elements</span>
        <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">elm</span><span class="o">.</span><span class="n">mats</span><span class="p">:</span>
                <span class="n">define_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">defined_materials</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="o">*</span><span class="n">elm</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>
            <span class="n">defined_elements</span><span class="p">[</span><span class="n">elm</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elm</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>
        <span class="c1"># TwoNodeLink element definition #</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>

        <span class="n">elms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">TwoNodeLink</span><span class="p">)</span>

        <span class="c1"># define twonodelink elements</span>
        <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mat</span> <span class="ow">in</span> <span class="n">elm</span><span class="o">.</span><span class="n">mats</span><span class="p">:</span>
                <span class="n">define_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">defined_materials</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="o">*</span><span class="n">elm</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>
            <span class="n">defined_elements</span><span class="p">[</span><span class="n">elm</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elm</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>
        <span class="c1"># TrussBar element definition #</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~ #</span>

        <span class="n">elms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">)</span>

        <span class="c1"># define TrussBar elements</span>
        <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elms</span><span class="p">:</span>
            <span class="n">define_material</span><span class="p">(</span><span class="n">elm</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">defined_materials</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">element</span><span class="p">(</span><span class="o">*</span><span class="n">elm</span><span class="o">.</span><span class="n">ops_args</span><span class="p">())</span>
            <span class="n">defined_elements</span><span class="p">[</span><span class="n">elm</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">elm</span>

        <span class="c1"># ~~~~~~~~~~~~~~~~ #</span>
        <span class="c1"># node constraints #</span>
        <span class="c1"># ~~~~~~~~~~~~~~~~ #</span>

        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">parent_nodes</span><span class="p">:</span>
            <span class="n">lvl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">parent_node_to_lvl</span><span class="p">[</span><span class="n">uid</span><span class="p">]]</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">lvl</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="n">good_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">lvl</span><span class="o">.</span><span class="n">elevation</span><span class="p">]</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">rigidDiaphragm</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">nd</span><span class="o">.</span><span class="n">uid</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">good_nodes</span><span class="p">])</span>

        <span class="c1"># # ~~~~~~~~~~~~~~~ #</span>
        <span class="c1"># # 1-dof appendage #</span>
        <span class="c1"># # ~~~~~~~~~~~~~~~ #</span>

        <span class="c1"># # we define a cantilever appendage in order to be able to</span>
        <span class="c1"># # capture all N eigenvalues, since the fast sparse solvers can</span>
        <span class="c1"># # only return up to N-1 eigenvalue-eigenvector pairs. The</span>
        <span class="c1"># # appendage must correspond to the highest frequency mode, so</span>
        <span class="c1"># # that it ends up being the only one that is omitted.</span>
        <span class="c1"># n_i_uid = self.mdl.uid_generator.new(&#39;node&#39;)</span>
        <span class="c1"># n_j_uid = self.mdl.uid_generator.new(&#39;node&#39;)</span>
        <span class="c1"># link_uid = self.mdl.uid_generator.new(&#39;element&#39;)</span>
        <span class="c1"># mat_uid = self.mdl.uid_generator.new(&#39;uniaxial material&#39;)</span>
        <span class="c1"># ops.node(n_i_uid, 100000.00, 0.00, 0.00)</span>
        <span class="c1"># ops.node(n_j_uid, 100000.00, 0.00, 0.00)</span>
        <span class="c1"># ops.fix(n_i_uid, True, True, True, True, True, True)</span>
        <span class="c1"># ops.mass(</span>
        <span class="c1">#     n_j_uid,</span>
        <span class="c1">#     common.EPSILON, common.EPSILON, common.EPSILON,</span>
        <span class="c1">#     common.EPSILON, common.EPSILON, common.EPSILON)</span>
        <span class="c1"># ops.uniaxialMaterial(&#39;Elastic&#39;, mat_uid, common.STIFF)</span>
        <span class="c1"># ops.element(</span>
        <span class="c1">#     &#39;zeroLength&#39;, link_uid, n_i_uid, n_j_uid,</span>
        <span class="c1">#     &#39;-mat&#39;, mat_uid, mat_uid, mat_uid, mat_uid, mat_uid, mat_uid,</span>
        <span class="c1">#     &#39;-dir&#39;, 1, 2, 3, 4, 5, 6</span>
        <span class="c1"># )</span>

    <span class="k">def</span> <span class="nf">_define_loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">timeSeries</span><span class="p">(</span><span class="s2">&quot;Linear&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">pattern</span><span class="p">(</span><span class="s2">&quot;Plain&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">elms_with_udl</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span>
            <span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span>
        <span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">elms_with_udl</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span><span class="n">elm</span> <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">)</span>
             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">)])</span>
        <span class="n">elms_with_udl</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span><span class="n">elm</span> <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">)</span>
             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elms_with_udl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">udl_total</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">line_element_udl</span><span class="p">[</span><span class="n">elm</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">udl_total</span> <span class="o">@</span> <span class="n">udl_total</span><span class="p">),</span> <span class="mf">0.00</span><span class="p">):</span>
                <span class="n">ops</span><span class="o">.</span><span class="n">eleLoad</span><span class="p">(</span>
                    <span class="s2">&quot;-ele&quot;</span><span class="p">,</span>
                    <span class="n">elm</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
                    <span class="s2">&quot;-type&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;-beamUniform&quot;</span><span class="p">,</span>
                    <span class="n">udl_total</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">udl_total</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">udl_total</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_all_nodes</span><span class="p">():</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_loads</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
            <span class="p">)</span>

    <span class="c1">####################################################</span>
    <span class="c1"># Methods that read back information from OpenSees #</span>
    <span class="c1">####################################################</span>

    <span class="k">def</span> <span class="nf">_read_node_displacements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">specific_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">specific_nodes</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">nodeDisp</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_read_node_velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">specific_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">specific_nodes</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">nodeVel</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_velocities</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_read_node_accelerations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">specific_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">specific_nodes</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">nodeAccel</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_accelerations</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_read_node_reactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">reactions</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">restraint</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">nodeReaction</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_reactions</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_read_frame_element_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">elems</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">uid</span>
            <span class="n">global_values</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">eleForce</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
            <span class="n">forces_global</span> <span class="o">=</span> <span class="n">global_values</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">moments_global_ends</span> <span class="o">=</span> <span class="n">global_values</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">)):</span>
                <span class="n">moments_global_clear</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">offset_transformation</span><span class="p">(</span>
                    <span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">offset_i</span><span class="p">,</span> <span class="n">moments_global_ends</span><span class="p">,</span> <span class="n">forces_global</span>
                <span class="p">)</span>
                <span class="n">x_vec</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">x_axis</span>
                <span class="n">y_vec</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">y_axis</span>
                <span class="n">z_vec</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">z_axis</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">moments_global_clear</span> <span class="o">=</span> <span class="n">moments_global_ends</span>
                <span class="n">x_vec</span><span class="p">,</span> <span class="n">y_vec</span><span class="p">,</span> <span class="n">z_vec</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">transformations</span><span class="o">.</span><span class="n">local_axes_from_points_and_angle</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elm</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elm</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span>
                        <span class="mf">0.00</span><span class="p">))</span>
            <span class="n">transf_global2local</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">y_vec</span><span class="p">,</span> <span class="n">z_vec</span><span class="p">))</span>
            <span class="n">n_i</span><span class="p">,</span> <span class="n">qy_i</span><span class="p">,</span> <span class="n">qz_i</span> <span class="o">=</span> <span class="n">transf_global2local</span> <span class="o">@</span> <span class="n">forces_global</span>
            <span class="n">t_i</span><span class="p">,</span> <span class="n">my_i</span><span class="p">,</span> <span class="n">mz_i</span> <span class="o">=</span> <span class="n">transf_global2local</span> <span class="o">@</span> <span class="n">moments_global_clear</span>
            <span class="n">forces</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">n_i</span><span class="p">,</span> <span class="n">qy_i</span><span class="p">,</span> <span class="n">qz_i</span><span class="p">,</span> <span class="n">t_i</span><span class="p">,</span> <span class="n">my_i</span><span class="p">,</span> <span class="n">mz_i</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">element_forces</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">forces</span>

    <span class="k">def</span> <span class="nf">_read_release_moment_rot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">zerolength_elms</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">release</span> <span class="ow">in</span> <span class="n">zerolength_elms</span><span class="p">:</span>
            <span class="c1"># force_global = ops.eleResponse(</span>
            <span class="c1">#     release.uid, &#39;force&#39;)[:3]</span>
            <span class="n">moment_global</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">eleResponse</span><span class="p">(</span><span class="n">release</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;force&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="c1"># disp_local = ops.eleResponse(</span>
            <span class="c1">#     release.uid, &#39;deformation&#39;)[:3]</span>
            <span class="n">rot_local</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">eleResponse</span><span class="p">(</span><span class="n">release</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;deformation&quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="c1"># note: j quantities are the opposite of those of</span>
            <span class="c1"># i by equilibrium</span>
            <span class="c1"># no need to store them too</span>
            <span class="c1"># rotation_global = ops.eleResponse(</span>
            <span class="c1">#     release.uid, &#39;deformation&#39;)[3:6]</span>
            <span class="c1"># convert to the local system</span>
            <span class="n">vec_x</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">vecx</span>
            <span class="n">vec_y</span> <span class="o">=</span> <span class="n">release</span><span class="o">.</span><span class="n">vecyp</span>
            <span class="n">vec_z</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">vec_x</span><span class="p">,</span> <span class="n">vec_y</span><span class="p">)</span>
            <span class="n">tmat_g2l</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">transformation_matrix</span><span class="p">(</span>
                <span class="n">vec_x</span><span class="p">,</span> <span class="n">vec_y</span><span class="p">,</span> <span class="n">vec_z</span>
            <span class="p">)</span>
            <span class="n">moment_local</span> <span class="o">=</span> <span class="n">tmat_g2l</span> <span class="o">@</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">moment_global</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">release_force_defo</span><span class="p">[</span><span class="n">release</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="o">*</span><span class="n">rot_local</span><span class="p">,</span>
                <span class="o">*</span><span class="n">moment_local</span><span class="p">,</span>
            <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_read_opensees_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">case_name</span><span class="p">,</span>
        <span class="n">step</span><span class="p">,</span>
        <span class="n">nodes</span><span class="p">,</span>
        <span class="n">line_elements</span><span class="p">,</span>
        <span class="n">zerolength_elements</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_node_displacements</span><span class="p">(</span><span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_node_velocities</span><span class="p">(</span><span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_node_accelerations</span><span class="p">(</span><span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_reactions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_node_reactions</span><span class="p">(</span><span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_forces</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_frame_element_forces</span><span class="p">(</span>
                <span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">line_elements</span>
            <span class="p">)</span>
        <span class="c1"># if self.settings.store_fiber:</span>
        <span class="c1">#     self._read_frame_fiber_stress_strain()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_release_force_defo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_release_moment_rot</span><span class="p">(</span><span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">zerolength_elements</span><span class="p">)</span>

    <span class="c1">##################################</span>
    <span class="c1"># Numeric Result Post-processing #</span>
    <span class="c1">##################################</span>

<div class="viewcode-block" id="Analysis.global_reactions"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.Analysis.global_reactions">[docs]</a>    <span class="k">def</span> <span class="nf">global_reactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates and returns the global reaction forces.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">reactions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">lvl</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">restraint</span><span class="p">:</span>
                    <span class="n">uid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uid</span>
                    <span class="n">x_coord</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">y_coord</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">z_coord</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">local_reaction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_reactions</span><span class="p">[</span>
                            <span class="n">uid</span>
                        <span class="p">][</span><span class="n">step</span><span class="p">])</span>
                    <span class="c1"># bug fix: It has been observed that sometimes</span>
                    <span class="c1"># OpenSees reports reactions to unrestrained DOFs.</span>
                    <span class="c1"># https://opensees.berkeley.edu/community/</span>
                    <span class="c1"># viewtopic.php?f=12&amp;t=70795</span>
                    <span class="c1"># To overcome this, we replace the reported</span>
                    <span class="c1"># reactions corresponding to unrestrained DOFs</span>
                    <span class="c1"># with zero in the following line</span>
                    <span class="n">local_reaction</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">restraint</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.00</span>

                    <span class="c1"># transfer moments to the global coordinate system</span>
                    <span class="n">global_reaction</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">local_reaction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">local_reaction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">local_reaction</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                            <span class="n">local_reaction</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">local_reaction</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_coord</span>
                            <span class="o">-</span> <span class="n">local_reaction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_coord</span><span class="p">,</span>
                            <span class="n">local_reaction</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">local_reaction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">z_coord</span>
                            <span class="o">-</span> <span class="n">local_reaction</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_coord</span><span class="p">,</span>
                            <span class="n">local_reaction</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                            <span class="o">+</span> <span class="n">local_reaction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_coord</span>
                            <span class="o">-</span> <span class="n">local_reaction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_coord</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="c1"># add to the global reactions</span>
                    <span class="n">reactions</span> <span class="o">+=</span> <span class="n">global_reaction</span>
        <span class="k">return</span> <span class="n">reactions</span></div></div>


<div class="viewcode-block" id="StaticAnalysis"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.StaticAnalysis">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">StaticAnalysis</span><span class="p">(</span><span class="n">Analysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Static analysis.  Stores all results (for each load case) in one</span>
<span class="sd">    single step.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StaticAnalysis.run"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.StaticAnalysis.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the static analysis.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_results</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">case_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_to_opensees_domain</span><span class="p">(</span><span class="n">case_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_define_loads</span><span class="p">(</span><span class="n">case_name</span><span class="p">)</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_all_nodes</span><span class="p">()</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">parent_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">elastic_elems</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">elm</span>
                <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span>
            <span class="p">]</span>
            <span class="n">disp_elems</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">elm</span>
                <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span>
            <span class="p">]</span>
            <span class="n">truss_elems</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">elm</span>
                <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span>
            <span class="p">]</span>
            <span class="n">line_elems</span> <span class="o">=</span> <span class="n">elastic_elems</span> <span class="o">+</span> <span class="n">disp_elems</span> <span class="o">+</span> <span class="n">truss_elems</span>
            <span class="n">zerolength_elems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ZeroLength</span><span class="p">)</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">numberer</span><span class="p">(</span><span class="n">NUMBERER</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">constraints</span><span class="p">(</span><span class="o">*</span><span class="n">CONSTRAINTS</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s2">&quot;EnergyIncr&quot;</span><span class="p">,</span> <span class="mf">1.0e-8</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">algorithm</span><span class="p">(</span><span class="s2">&quot;Newton&quot;</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">integrator</span><span class="p">(</span><span class="s2">&quot;LoadControl&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">analysis</span><span class="p">(</span><span class="s2">&quot;Static&quot;</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_opensees_results</span><span class="p">(</span>
                <span class="n">case_name</span><span class="p">,</span>
                <span class="n">step</span><span class="p">,</span>
                <span class="n">nodes</span><span class="p">,</span>
                <span class="n">line_elems</span><span class="p">,</span>
                <span class="n">zerolength_elems</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">pickle_results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_results_to_disk</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ModalAnalysis"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.ModalAnalysis">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModalAnalysis</span><span class="p">(</span><span class="n">Analysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs a modal analysis.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_modes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">####################################################</span>
    <span class="c1"># Methods that read back information from OpenSees #</span>
    <span class="c1">####################################################</span>

    <span class="k">def</span> <span class="nf">_read_node_displacements_modal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_all_nodes</span><span class="p">()</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">parent_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">nodeEigenvector</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_read_frame_element_forces_modal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">elems</span><span class="p">):</span>
        <span class="c1"># note: opensees does not output the element forces that correspond</span>
        <span class="c1"># to the displacement field of each obtained mode.</span>
        <span class="c1"># to overcome this, we run a separate analysis imposing those</span>
        <span class="c1"># displacements to get the element forces.</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
                <span class="c1"># displacements at the two ends (global system)</span>
                <span class="n">u_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span>
                    <span class="n">elm</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uid</span>
                <span class="p">][</span><span class="n">step</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">r_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span>
                    <span class="n">elm</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">uid</span>
                <span class="p">][</span><span class="n">step</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
                <span class="n">u_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span>
                    <span class="n">elm</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">uid</span>
                <span class="p">][</span><span class="n">step</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">r_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span>
                    <span class="n">elm</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">uid</span>
                <span class="p">][</span><span class="n">step</span><span class="p">][</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">):</span>
                    <span class="n">offset_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">offset_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">u_i_o</span> <span class="o">=</span> <span class="n">u_i</span>
                    <span class="n">u_j_o</span> <span class="o">=</span> <span class="n">u_j</span>
                    <span class="n">x_vec</span><span class="p">,</span> <span class="n">y_vec</span><span class="p">,</span> <span class="n">z_vec</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">transformations</span><span class="o">.</span><span class="n">local_axes_from_points_and_angle</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elm</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elm</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">),</span> <span class="mf">0.00</span>
                        <span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">offset_i</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">offset_i</span>
                    <span class="n">offset_j</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">offset_j</span>
                    <span class="n">u_i_o</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">offset_transformation</span><span class="p">(</span>
                        <span class="n">offset_i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u_i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r_i</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">u_j_o</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">offset_transformation</span><span class="p">(</span>
                        <span class="n">offset_j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u_j</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r_j</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">x_vec</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">x_axis</span>
                    <span class="n">y_vec</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">geomtransf</span><span class="o">.</span><span class="n">y_axis</span>
                    <span class="n">z_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">x_vec</span><span class="p">,</span> <span class="n">y_vec</span><span class="p">)</span>

                    <span class="c1"># element UDL: shouldn&#39;t be there in a modal analysis</span>
                    <span class="n">udl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">line_element_udl</span><span class="p">[</span><span class="n">elm</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
                    <span class="c1"># note: modal analysis doesn&#39;t account for applied loads.</span>
                    <span class="c1"># this will cause issues with plotting if loads</span>
                    <span class="c1"># have been applied.</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">udl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">common</span><span class="o">.</span><span class="n">EPSILON</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Loads applied at modal load case.&quot;</span><span class="p">)</span>
                    <span class="c1"># (could alternatively just ignore them?..)</span>

                <span class="c1"># global -&gt; local transformation matrix</span>
                <span class="n">transf_global2local</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">transformation_matrix</span><span class="p">(</span>
                    <span class="n">x_vec</span><span class="p">,</span> <span class="n">y_vec</span><span class="p">,</span> <span class="n">z_vec</span>
                <span class="p">)</span>

                <span class="n">u_i_local</span> <span class="o">=</span> <span class="n">transf_global2local</span> <span class="o">@</span> <span class="n">u_i_o</span>
                <span class="n">r_i_local</span> <span class="o">=</span> <span class="n">transf_global2local</span> <span class="o">@</span> <span class="n">r_i</span>
                <span class="n">u_j_local</span> <span class="o">=</span> <span class="n">transf_global2local</span> <span class="o">@</span> <span class="n">u_j_o</span>
                <span class="n">r_j_local</span> <span class="o">=</span> <span class="n">transf_global2local</span> <span class="o">@</span> <span class="n">r_j</span>

                <span class="c1"># stiffness matrix terms</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">uniaxial_material</span><span class="o">.</span><span class="n">Elastic</span><span class="p">):</span>
                        <span class="n">e_mod</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">e_mod</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                            <span class="s1">&#39;Ignoring truss element with &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">elm</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> material&#39;</span><span class="p">)</span>
                        <span class="n">e_mod</span> <span class="o">=</span> <span class="mf">0.00</span>
                    <span class="n">etimesa</span> <span class="o">=</span> <span class="n">e_mod</span> <span class="o">*</span> <span class="n">elm</span><span class="o">.</span><span class="n">area</span>
                    <span class="n">etimesi_maj</span> <span class="o">=</span> <span class="mf">0.00</span>
                    <span class="n">etimesi_min</span> <span class="o">=</span> <span class="mf">0.00</span>
                    <span class="n">gtimesj</span> <span class="o">=</span> <span class="mf">0.00</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">):</span>
                    <span class="n">etimesa</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">e_mod</span> <span class="o">*</span> <span class="n">elm</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">area</span>
                    <span class="n">etimesi_maj</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">e_mod</span> <span class="o">*</span> <span class="n">elm</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">i_x</span>
                    <span class="n">etimesi_min</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">e_mod</span> <span class="o">*</span> <span class="n">elm</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">i_y</span>
                    <span class="n">gtimesj</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">g_mod</span> <span class="o">*</span> <span class="n">elm</span><span class="o">.</span><span class="n">section</span><span class="o">.</span><span class="n">j_mod</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Oops! Need to extend the code &#39;</span>
                        <span class="s1">&#39;to support dispBeamColumn elements&#39;</span><span class="p">)</span>

                <span class="n">length</span> <span class="o">=</span> <span class="n">elm</span><span class="o">.</span><span class="n">clear_length</span><span class="p">()</span>

                <span class="n">deformation_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">u_i_local</span><span class="p">,</span> <span class="n">r_i_local</span><span class="p">,</span> <span class="n">u_j_local</span><span class="p">,</span> <span class="n">r_j_local</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="c1"># axial load</span>
                <span class="n">n_i</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">etimesa</span> <span class="o">/</span> <span class="n">length</span><span class="p">,</span> <span class="o">-</span><span class="n">etimesa</span> <span class="o">/</span> <span class="n">length</span><span class="p">]])</span>
<div class="viewcode-block" id="ModalAnalysis.run"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.ModalAnalysis.run">[docs]</a>                    <span class="o">@</span> <span class="n">deformation_vector</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]]</span>
                <span class="p">)</span>

                <span class="c1"># torsion</span>
                <span class="n">t_i</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">gtimesj</span> <span class="o">/</span> <span class="n">length</span><span class="p">,</span> <span class="o">-</span><span class="n">gtimesj</span> <span class="o">/</span> <span class="n">length</span><span class="p">]])</span>
                    <span class="o">@</span> <span class="n">deformation_vector</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
                <span class="p">)</span>

                <span class="c1"># major shear and minor bending</span>
                <span class="n">f3_m2</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="p">[</span>
                                <span class="mf">12.00</span> <span class="o">*</span> <span class="n">etimesi_min</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
                                <span class="o">-</span><span class="mf">6.00</span> <span class="o">*</span> <span class="n">etimesi_min</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                <span class="o">-</span><span class="mf">12.00</span> <span class="o">*</span> <span class="n">etimesi_min</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
                                <span class="o">-</span><span class="mf">6.00</span> <span class="o">*</span> <span class="n">etimesi_min</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                            <span class="p">],</span>
                            <span class="p">[</span>
                                <span class="o">-</span><span class="mf">6.00</span> <span class="o">*</span> <span class="n">etimesi_min</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                <span class="mf">4.00</span> <span class="o">*</span> <span class="n">etimesi_min</span> <span class="o">/</span> <span class="n">length</span><span class="p">,</span>
                                <span class="mf">6.00</span> <span class="o">*</span> <span class="n">etimesi_min</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                <span class="mf">2.00</span> <span class="o">*</span> <span class="n">etimesi_min</span> <span class="o">/</span> <span class="n">length</span><span class="p">,</span>
                            <span class="p">],</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">@</span> <span class="n">deformation_vector</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">]]</span>
                <span class="p">)</span>

                <span class="c1"># minor shear and major bending</span>
                <span class="n">f2_m3</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="p">[</span>
                                <span class="mf">12.00</span> <span class="o">*</span> <span class="n">etimesi_maj</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
                                <span class="mf">6.00</span> <span class="o">*</span> <span class="n">etimesi_maj</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                <span class="o">-</span><span class="mf">12.00</span> <span class="o">*</span> <span class="n">etimesi_maj</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
                                <span class="mf">6.00</span> <span class="o">*</span> <span class="n">etimesi_maj</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                            <span class="p">],</span>
                            <span class="p">[</span>
                                <span class="mf">6.00</span> <span class="o">*</span> <span class="n">etimesi_maj</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                <span class="mf">4.00</span> <span class="o">*</span> <span class="n">etimesi_maj</span> <span class="o">/</span> <span class="n">length</span><span class="p">,</span>
                                <span class="o">-</span><span class="mf">6.00</span> <span class="o">*</span> <span class="n">etimesi_maj</span> <span class="o">/</span> <span class="n">length</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                                <span class="mf">2.00</span> <span class="o">*</span> <span class="n">etimesi_maj</span> <span class="o">/</span> <span class="n">length</span><span class="p">,</span>
                            <span class="p">],</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">@</span> <span class="n">deformation_vector</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">]]</span>
                <span class="p">)</span>

                <span class="n">forces_vector_local</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">n_i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f2_m3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f3_m2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f3_m2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f2_m3</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">)</span>

                <span class="c1"># store results</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">element_forces</span>
                    <span class="c1"># [elm.uid][step]) = \</span>
                    <span class="c1">#    np.array((n_i, qy_i, qzi, t_i, myi, mz_i))</span>
                    <span class="p">[</span><span class="n">elm</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="n">step</span><span class="p">]</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">forces_vector_local</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the modal analysis.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_results</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">case_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_to_opensees_domain</span><span class="p">(</span><span class="n">case_name</span><span class="p">)</span>
            <span class="c1"># tags = ops.getNodeTags()</span>
            <span class="c1"># self.print(len(tags))</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">constraints</span><span class="p">(</span><span class="o">*</span><span class="n">CONSTRAINTS</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s1">&#39;sparsesym&#39;</span><span class="p">,</span> <span class="s1">&#39;sparsespd&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">solver</span><span class="si">}</span><span class="s1"> is unable &#39;</span>
                    <span class="s1">&#39;to run a modal analysis. Use UmfPack.&#39;</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
            <span class="c1"># note: using SparseSYM results in wrong eigen decomposition</span>
            <span class="n">num_inertial_nodes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ndtags</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">getNodeTags</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ndtags</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ops</span><span class="o">.</span><span class="n">nodeMass</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.00</span><span class="p">:</span>
                        <span class="n">num_inertial_nodes</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">eigenvalues</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">eigen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">periods</span> <span class="o">=</span> <span class="p">(</span>
                <span class="mf">2.00</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_node_displacements_modal</span><span class="p">(</span><span class="n">case_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_forces</span><span class="p">:</span>
                <span class="n">line_elements</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">,</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">,</span>
                    <span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span>
                <span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">line_elements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">elm</span> <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">)</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">)])</span>
                <span class="n">line_elements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">elm</span> <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">)</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">)])</span>
                <span class="n">line_elements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">elm</span> <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">)</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">)])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_frame_element_forces_modal</span><span class="p">(</span>
                    <span class="n">case_name</span><span class="p">,</span> <span class="n">line_elements</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">pickle_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_results_to_disk</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModalAnalysis.modal_participation_factors"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.ModalAnalysis.modal_participation_factors">[docs]</a>    <span class="k">def</span> <span class="nf">modal_participation_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates modal participation factors</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dof_dir</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
        <span class="n">ntgs</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">getNodeTags</span><span class="p">()</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">)</span>
        <span class="n">mstars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">)</span>
        <span class="n">mn_tot</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">ntg</span> <span class="ow">in</span> <span class="n">ntgs</span><span class="p">:</span>
            <span class="n">node_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_mass</span><span class="p">[</span><span class="n">ntg</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
            <span class="n">mn_tot</span> <span class="o">+=</span> <span class="n">node_mass</span><span class="p">[</span><span class="n">dof_dir</span><span class="p">[</span><span class="n">direction</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">):</span>
            <span class="n">l_n</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">m_n</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">ntg</span> <span class="ow">in</span> <span class="n">ntgs</span><span class="p">:</span>
                <span class="n">node_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_mass</span><span class="p">[</span><span class="n">ntg</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
                <span class="n">node_phi</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">nodeEigenvector</span><span class="p">(</span><span class="n">ntg</span><span class="p">,</span> <span class="n">mode</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">l_n</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">node_phi</span><span class="p">[</span><span class="n">dof_dir</span><span class="p">[</span><span class="n">direction</span><span class="p">]]</span>
                    <span class="o">*</span> <span class="n">node_mass</span><span class="p">[</span><span class="n">dof_dir</span><span class="p">[</span><span class="n">direction</span><span class="p">]]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">dof</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                    <span class="n">m_n</span> <span class="o">+=</span> <span class="p">(</span><span class="n">node_phi</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">node_mass</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span>
            <span class="n">gammas</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_n</span> <span class="o">/</span> <span class="n">m_n</span>
            <span class="n">mstars</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_n</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">m_n</span>
        <span class="n">mstars</span> <span class="o">/=</span> <span class="n">mn_tot</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">gammas</span><span class="p">,</span> <span class="n">mstars</span><span class="p">,</span> <span class="n">mn_tot</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GravityPlusAnalysis"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.GravityPlusAnalysis">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">GravityPlusAnalysis</span><span class="p">(</span><span class="n">Analysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When performing nonlinear static or dynamic analysis, it is common</span>
<span class="sd">    to first apply gravitly loads on the model and then proceed with</span>
<span class="sd">    some other analysis, like static pushover or transient dynamic</span>
<span class="sd">    analysis. This parent class is used to define analysis objects</span>
<span class="sd">    that follow this practice.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_run_gravity_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;G: Setting test to (&#39;EnergyIncr&#39;, 1.0e-6, 100, 3)&quot;</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s2">&quot;EnergyIncr&quot;</span><span class="p">,</span> <span class="mf">1.0e-6</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;G: Setting system solver to </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;G: Setting numberer to </span><span class="si">{</span><span class="n">NUMBERER</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">numberer</span><span class="p">(</span><span class="n">NUMBERER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;G: Setting constraints to </span><span class="si">{</span><span class="p">[</span><span class="o">*</span><span class="n">CONSTRAINTS</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">constraints</span><span class="p">(</span><span class="o">*</span><span class="n">CONSTRAINTS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;G: Setting algorithm to RaphsonNewton&quot;</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">algorithm</span><span class="p">(</span><span class="s2">&quot;RaphsonNewton&quot;</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">integrator</span><span class="p">(</span><span class="s2">&quot;LoadControl&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;G: Setting analysis to Static&quot;</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">analysis</span><span class="p">(</span><span class="s2">&quot;Static&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;G: Analyzing now.&quot;</span><span class="p">)</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Gravity analysis failed. Unable to continue...&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Analysis Failed&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GravityPlusAnalysis.retrieve_node_displacement"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.GravityPlusAnalysis.retrieve_node_displacement">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_node_displacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the displacement of a node for all analysis steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">case_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;case_name </span><span class="si">{</span><span class="n">case_name</span><span class="si">}</span><span class="s2"> not found in results.&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">n_steps_success</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ux&quot;</span><span class="p">,</span> <span class="s2">&quot;uy&quot;</span><span class="p">,</span> <span class="s2">&quot;uz&quot;</span><span class="p">,</span> <span class="s2">&quot;urx&quot;</span><span class="p">,</span> <span class="s2">&quot;ury&quot;</span><span class="p">,</span> <span class="s2">&quot;urz&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">dframe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;step&quot;</span>
        <span class="k">return</span> <span class="n">dframe</span></div>

<div class="viewcode-block" id="GravityPlusAnalysis.retrieve_node_acceleration"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.GravityPlusAnalysis.retrieve_node_acceleration">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_node_acceleration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the acceleration of a node for all analysis steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">n_steps_success</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_accelerations</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_accelerations</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ax&quot;</span><span class="p">,</span> <span class="s2">&quot;ay&quot;</span><span class="p">,</span> <span class="s2">&quot;az&quot;</span><span class="p">,</span> <span class="s2">&quot;arx&quot;</span><span class="p">,</span> <span class="s2">&quot;ary&quot;</span><span class="p">,</span> <span class="s2">&quot;arz&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">dframe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;step&quot;</span>
        <span class="k">return</span> <span class="n">dframe</span></div>

<div class="viewcode-block" id="GravityPlusAnalysis.retrieve_node_velocity"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.GravityPlusAnalysis.retrieve_node_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_node_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the velocity of a node for all analysis steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">n_steps_success</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_velocities</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_velocities</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;vy&quot;</span><span class="p">,</span> <span class="s2">&quot;vz&quot;</span><span class="p">,</span> <span class="s2">&quot;vrx&quot;</span><span class="p">,</span> <span class="s2">&quot;vry&quot;</span><span class="p">,</span> <span class="s2">&quot;vrz&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">dframe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;step&quot;</span>
        <span class="k">return</span> <span class="n">dframe</span></div>

<div class="viewcode-block" id="GravityPlusAnalysis.retrieve_node_abs_acceleration"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.GravityPlusAnalysis.retrieve_node_abs_acceleration">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_node_abs_acceleration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the absolute acceleration of a node for all analysis</span>
<span class="sd">        steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">n_steps_success</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_accelerations</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">THAnalysis</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_accelerations</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">:</span>
                <span class="n">a_g</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">res</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a_g</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_vector</span><span class="p">)</span> <span class="o">*</span> <span class="n">common</span><span class="o">.</span><span class="n">G_CONST_IMPERIAL</span>
                <span class="c1"># TODO: update to support SI</span>
        <span class="n">dframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">res</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;abs ax&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs ay&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs az&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs arx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs ary&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs arz&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="n">dframe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;step&quot;</span>
        <span class="k">return</span> <span class="n">dframe</span></div>

<div class="viewcode-block" id="GravityPlusAnalysis.retrieve_node_abs_velocity"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.GravityPlusAnalysis.retrieve_node_abs_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_node_abs_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the absolute velocity of a node for all analysis steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">n_steps_success</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_velocities</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">THAnalysis</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_velocities</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">:</span>
                <span class="n">a_g</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.00</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">v_g</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">cumulative_trapezoid</span><span class="p">(</span>
                    <span class="n">a_g</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_vector</span><span class="p">)</span> <span class="o">*</span> <span class="n">common</span><span class="o">.</span><span class="n">G_CONST_IMPERIAL</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time_vector</span><span class="p">,</span>
                    <span class="n">initial</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">res</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">v_g</span>
        <span class="n">dfrmae</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">res</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;abs vx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs vy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs vz&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs vrx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs vry&quot;</span><span class="p">,</span>
                <span class="s2">&quot;abs vrz&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="n">dfrmae</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;step&quot;</span>
        <span class="k">return</span> <span class="n">dfrmae</span></div>

<div class="viewcode-block" id="GravityPlusAnalysis.retrieve_release_force_defo"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.GravityPlusAnalysis.retrieve_release_force_defo">[docs]</a>    <span class="k">def</span> <span class="nf">retrieve_release_force_defo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">case_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the force-deformation of a zerolength element for all</span>
<span class="sd">        analysis steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">release_force_defo</span><span class="p">[</span><span class="n">uid</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">release_force_defo</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;u1&quot;</span><span class="p">,</span> <span class="s2">&quot;u2&quot;</span><span class="p">,</span> <span class="s2">&quot;u3&quot;</span><span class="p">,</span> <span class="s2">&quot;q1&quot;</span><span class="p">,</span> <span class="s2">&quot;q2&quot;</span><span class="p">,</span> <span class="s2">&quot;q3&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">dframe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;step&quot;</span>
        <span class="k">return</span> <span class="n">dframe</span></div></div>


<div class="viewcode-block" id="PushoverAnalysis"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.PushoverAnalysis">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PushoverAnalysis</span><span class="p">(</span><span class="n">GravityPlusAnalysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pushover analysis</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_apply_lateral_load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">modeshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">LoadCaseQuery</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">])</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">level_masses</span><span class="p">()</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">distribution</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">distribution</span><span class="p">)</span>

        <span class="c1"># define the load pattern</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">timeSeries</span><span class="p">(</span><span class="s2">&quot;Linear&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">pattern</span><span class="p">(</span><span class="s2">&quot;Plain&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
            <span class="n">load_dir</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="n">load_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span>
            <span class="n">load_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid direction&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">modeshape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Can&#39;t apply lateral loads based on the 1st &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;mode shape in the z direction.&quot;</span>
                <span class="p">)</span>
            <span class="n">modeshape_ampl</span> <span class="o">=</span> <span class="n">modeshape</span> <span class="o">/</span> <span class="n">modeshape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modeshape_ampl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="c1"># if a node is given, apply the incremental load on that node</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="mf">1.00</span> <span class="o">*</span> <span class="n">load_dir</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">lvl</span><span class="o">.</span><span class="n">uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">parent_nodes</span><span class="p">:</span>
                    <span class="n">node_list</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">parent_nodes</span><span class="p">[</span><span class="n">lvl</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lvl</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">masses</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_mass</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node_list</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">masses</span> <span class="o">=</span> <span class="n">masses</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">masses</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">some_node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node_list</span><span class="p">):</span>
                    <span class="n">ops</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="n">some_node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
                        <span class="o">*</span><span class="p">(</span>
                            <span class="n">distribution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="o">*</span> <span class="n">masses</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="o">*</span> <span class="n">load_dir</span>
                            <span class="o">*</span> <span class="n">modeshape_ampl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

<div class="viewcode-block" id="PushoverAnalysis.run"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.PushoverAnalysis.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">direction</span><span class="p">,</span>
        <span class="n">target_displacements</span><span class="p">,</span>
        <span class="n">control_node</span><span class="p">,</span>
        <span class="n">displ_incr</span><span class="p">,</span>
        <span class="n">modeshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">loaded_node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run pushover analysis</span>

<span class="sd">        Arguments:</span>
<span class="sd">          direction: can be any of &#39;x&#39;, &#39;y&#39;, &#39;z&#39;</span>
<span class="sd">          target_displacements: a list of target displacements.  each</span>
<span class="sd">            time a target is reached, the analysis continues until the</span>
<span class="sd">            next target is reached, flipping the direction as</span>
<span class="sd">            necessary.</span>
<span class="sd">          control_node: analysis control node (of which the direction</span>
<span class="sd">            is queried)</span>
<span class="sd">          displ_incr: initial displacement increment.</span>
<span class="sd">          mode shape: array containing a mode shape that is used to</span>
<span class="sd">            distribute the applied incremental loads. If no mode shape</span>
<span class="sd">            is specified, the distribution is uniform.</span>
<span class="sd">          loaded_node: if a loaded node is specified, all incremental</span>
<span class="sd">            load is applied entirely on that node.  Otherwise, the</span>
<span class="sd">            incremental loads are distributed to all nodes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Direction: </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
            <span class="n">control_dof</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="n">control_dof</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span>
            <span class="n">control_dof</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Direction can be &#39;x&#39;, &#39;y&#39; or &#39;z&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Initializing containers&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_results</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">case_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load case: </span><span class="si">{</span><span class="n">case_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_all_nodes</span><span class="p">()</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">parent_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">elastic_elems</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">elm</span>
                <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span>
            <span class="p">]</span>
            <span class="n">disp_elems</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">elm</span>
                <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span>
            <span class="p">]</span>
            <span class="n">truss_elems</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">elm</span>
                <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span>
            <span class="p">]</span>
            <span class="n">line_elems</span> <span class="o">=</span> <span class="n">elastic_elems</span> <span class="o">+</span> <span class="n">disp_elems</span> <span class="o">+</span> <span class="n">truss_elems</span>
            <span class="n">zerolength_elems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ZeroLength</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Defining elements in OpenSees&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_to_opensees_domain</span><span class="p">(</span><span class="n">case_name</span><span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Defining loads&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_define_loads</span><span class="p">(</span><span class="n">case_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Running gravity analysis&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_gravity_analysis</span><span class="p">()</span>

            <span class="n">curr_displ</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">nodeDisp</span><span class="p">(</span><span class="n">control_node</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">control_dof</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">n_steps_success</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_opensees_results</span><span class="p">(</span>
                <span class="n">case_name</span><span class="p">,</span>
                <span class="n">n_steps_success</span><span class="p">,</span>
                <span class="n">nodes</span><span class="p">,</span>
                <span class="n">line_elems</span><span class="p">,</span>
                <span class="n">zerolength_elems</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Starting pushover analysis&quot;</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">wipeAnalysis</span><span class="p">()</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">loadConst</span><span class="p">(</span><span class="s2">&quot;-time&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_lateral_load</span><span class="p">(</span>
                <span class="n">case_name</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">modeshape</span><span class="p">,</span> <span class="n">loaded_node</span>
            <span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">numberer</span><span class="p">(</span><span class="n">NUMBERER</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">constraints</span><span class="p">(</span><span class="o">*</span><span class="n">CONSTRAINTS</span><span class="p">)</span>

            <span class="n">total_fail</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">num_subdiv</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_times</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">scale</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="mf">1.0e-1</span><span class="p">,</span> <span class="mf">1.0e-1</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">i_loop</span><span class="p">,</span> <span class="n">target_displacement</span> \
                    <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_displacements</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">total_fail</span><span class="p">:</span>
                        <span class="k">break</span>

                    <span class="c1"># determine push direction</span>
                    <span class="k">if</span> <span class="n">curr_displ</span> <span class="o">&lt;</span> <span class="n">target_displacement</span><span class="p">:</span>
                        <span class="n">displ_incr</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">displ_incr</span><span class="p">)</span>
                        <span class="n">sign</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.00</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">displ_incr</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">displ_incr</span><span class="p">)</span>
                        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.00</span>

                    <span class="k">while</span> <span class="n">curr_displ</span> <span class="o">*</span> <span class="n">sign</span> <span class="o">&lt;</span> <span class="n">target_displacement</span> <span class="o">*</span> <span class="n">sign</span><span class="p">:</span>

                        <span class="c1"># determine increment</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="nb">abs</span><span class="p">(</span><span class="n">curr_displ</span> <span class="o">-</span> <span class="n">target_displacement</span><span class="p">)</span>
                            <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">displ_incr</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="n">num_subdiv</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">incr</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">curr_displ</span> <span class="o">-</span> <span class="n">target_displacement</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">incr</span> <span class="o">=</span> <span class="n">displ_incr</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="n">num_subdiv</span><span class="p">]</span>
                        <span class="n">ops</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
                            <span class="s2">&quot;NormDispIncr&quot;</span><span class="p">,</span>
                            <span class="n">norm</span><span class="p">[</span><span class="n">num_subdiv</span><span class="p">],</span>
                            <span class="n">steps</span><span class="p">[</span><span class="n">num_subdiv</span><span class="p">],</span>
                            <span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">ops</span><span class="o">.</span><span class="n">algorithm</span><span class="p">(</span><span class="s2">&quot;RaphsonNewton&quot;</span><span class="p">)</span>
                        <span class="c1"># ops.integrator(&quot;ArcLength&quot;, 1.00e1, 1.00e-7)</span>
                        <span class="n">ops</span><span class="o">.</span><span class="n">integrator</span><span class="p">(</span>
                            <span class="s2">&quot;DisplacementControl&quot;</span><span class="p">,</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">control_node</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span>
                            <span class="n">control_dof</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">incr</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">ops</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
                        <span class="n">ops</span><span class="o">.</span><span class="n">analysis</span><span class="p">(</span><span class="s2">&quot;Static&quot;</span><span class="p">)</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">num_subdiv</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># can&#39;t refine further</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;===========================&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Analysis failed to converge&quot;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;===========================&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                        <span class="s2">&quot;Analysis failed&quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot; at disp </span><span class="si">{</span><span class="n">curr_displ</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">)</span>
                                <span class="n">total_fail</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                            <span class="c1"># can still reduce step size</span>
                            <span class="n">num_subdiv</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="c1"># how many times to run with reduced step size</span>
                            <span class="n">num_times</span> <span class="o">=</span> <span class="mi">10</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># analysis was successful</span>
                            <span class="k">if</span> <span class="n">num_times</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">num_times</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="n">n_steps_success</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_read_opensees_results</span><span class="p">(</span>
                                <span class="n">case_name</span><span class="p">,</span>
                                <span class="n">n_steps_success</span><span class="p">,</span>
                                <span class="n">nodes</span><span class="p">,</span>
                                <span class="n">line_elems</span><span class="p">,</span>
                                <span class="n">zerolength_elems</span>
                            <span class="p">)</span>

                            <span class="n">curr_displ</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">nodeDisp</span><span class="p">(</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">control_node</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="n">control_dof</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Loop (</span><span class="si">{</span><span class="n">i_loop</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">target_displacements</span><span class="p">)</span><span class="si">}</span><span class="s2">) | &quot;</span>
                                <span class="s2">&quot;Target displacement: &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_displacement</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot; | Current: </span><span class="si">{</span><span class="n">curr_displ</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">num_subdiv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">num_times</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">num_subdiv</span> <span class="o">-=</span> <span class="mi">1</span>
                                    <span class="n">num_times</span> <span class="o">=</span> <span class="mi">10</span>

            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Analysis interrupted&quot;</span><span class="p">)</span>

            <span class="n">n_steps_success</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_opensees_results</span><span class="p">(</span>
                <span class="n">case_name</span><span class="p">,</span>
                <span class="n">n_steps_success</span><span class="p">,</span>
                <span class="n">nodes</span><span class="p">,</span>
                <span class="n">line_elems</span><span class="p">,</span>
                <span class="n">zerolength_elems</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of saved analysis steps: </span><span class="si">{</span><span class="n">n_steps_success</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;successful steps&quot;</span><span class="p">:</span> <span class="n">n_steps_success</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">n_steps_success</span> <span class="o">=</span> <span class="n">n_steps_success</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="c1"># done with all cases.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">pickle_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_results_to_disk</span><span class="p">()</span></div>

<div class="viewcode-block" id="PushoverAnalysis.table_pushover_curve"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.PushoverAnalysis.table_pushover_curve">[docs]</a>    <span class="k">def</span> <span class="nf">table_pushover_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the force deformation results</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
            <span class="n">control_dof</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
            <span class="n">control_dof</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span>
            <span class="n">control_dof</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Direction can be &#39;x&#39;, &#39;y&#39; or &#39;z&#39;&quot;</span><span class="p">)</span>
        <span class="n">base_shear_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">displacement_lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">n_steps_success</span>
        <span class="p">):</span>  <span class="c1"># type:ignore</span>
            <span class="n">base_shear_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_reactions</span><span class="p">(</span><span class="n">case_name</span><span class="p">,</span> <span class="n">step</span><span class="p">)[</span><span class="n">control_dof</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">displacement_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="n">step</span><span class="p">][</span>
                    <span class="n">control_dof</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">base_shear</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">base_shear_lst</span><span class="p">)</span>
        <span class="n">displacement</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">displacement_lst</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">displacement</span><span class="p">,</span> <span class="n">base_shear</span></div>

<div class="viewcode-block" id="PushoverAnalysis.plot_pushover_curve"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.PushoverAnalysis.plot_pushover_curve">[docs]</a>    <span class="k">def</span> <span class="nf">plot_pushover_curve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the pushover curve</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: units</span>
        <span class="n">displacement</span><span class="p">,</span> <span class="n">base_shear</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_pushover_curve</span><span class="p">(</span>
            <span class="n">case_name</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">node</span>
        <span class="p">)</span>
        <span class="n">general_2d</span><span class="o">.</span><span class="n">line_plot_interactive</span><span class="p">(</span>
            <span class="s2">&quot;Pushover Analysis Results&lt;br&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;Direction: &quot;</span> <span class="o">+</span> <span class="n">direction</span><span class="p">,</span>
            <span class="n">displacement</span><span class="p">,</span>
            <span class="n">base_shear</span><span class="p">,</span>
            <span class="s2">&quot;spline+markers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Displacement&quot;</span><span class="p">,</span>
            <span class="s2">&quot;in&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.0f&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Base Shear&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.0f&quot;</span><span class="p">,</span>
        <span class="p">)</span></div></div>

<div class="viewcode-block" id="define_lateral_load_pattern"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.define_lateral_load_pattern">[docs]</a><span class="k">def</span> <span class="nf">define_lateral_load_pattern</span><span class="p">(</span>
    <span class="n">filename_x</span><span class="p">,</span> <span class="n">filename_y</span><span class="p">,</span> <span class="n">filename_z</span><span class="p">,</span> <span class="n">file_time_incr</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines the load pattern for a time-history analysis from</span>
<span class="sd">    previously parsed files with a constant dt</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">filename_x</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># define X-direction TH</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">timeSeries</span><span class="p">(</span>
            <span class="s2">&quot;Path&quot;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;-dt&quot;</span><span class="p">,</span>
            <span class="n">file_time_incr</span><span class="p">,</span>
            <span class="s2">&quot;-filePath&quot;</span><span class="p">,</span>
            <span class="n">filename_x</span><span class="p">,</span>
            <span class="s2">&quot;-factor&quot;</span><span class="p">,</span>
            <span class="n">common</span><span class="o">.</span><span class="n">G_CONST_IMPERIAL</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># pattern, direction, time series tag</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">pattern</span><span class="p">(</span><span class="s2">&quot;UniformExcitation&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;-accel&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename_y</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># define Y-direction TH</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">timeSeries</span><span class="p">(</span>
            <span class="s2">&quot;Path&quot;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;-dt&quot;</span><span class="p">,</span>
            <span class="n">file_time_incr</span><span class="p">,</span>
            <span class="s2">&quot;-filePath&quot;</span><span class="p">,</span>
            <span class="n">filename_y</span><span class="p">,</span>
            <span class="s2">&quot;-factor&quot;</span><span class="p">,</span>
            <span class="n">common</span><span class="o">.</span><span class="n">G_CONST_IMPERIAL</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># pattern, direction, time series tag</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">pattern</span><span class="p">(</span><span class="s2">&quot;UniformExcitation&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;-accel&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filename_z</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># define Z-direction TH</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">timeSeries</span><span class="p">(</span>
            <span class="s2">&quot;Path&quot;</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;-dt&quot;</span><span class="p">,</span>
            <span class="n">file_time_incr</span><span class="p">,</span>
            <span class="s2">&quot;-filePath&quot;</span><span class="p">,</span>
            <span class="n">filename_z</span><span class="p">,</span>
            <span class="s2">&quot;-factor&quot;</span><span class="p">,</span>
            <span class="n">common</span><span class="o">.</span><span class="n">G_CONST_IMPERIAL</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># pattern, direction, time series tag</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">pattern</span><span class="p">(</span><span class="s2">&quot;UniformExcitation&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;-accel&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No input files specified.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_ground_motion"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.plot_ground_motion">[docs]</a><span class="k">def</span> <span class="nf">plot_ground_motion</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_time_incr</span><span class="p">,</span> <span class="n">gmunit</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">plotly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots a ground motion input file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span>
    <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.00</span><span class="p">,</span> <span class="n">n_points</span> <span class="o">*</span> <span class="n">file_time_incr</span><span class="p">,</span> <span class="n">file_time_incr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plotly</span><span class="p">:</span>
        <span class="n">general_2d</span><span class="o">.</span><span class="n">line_plot_interactive</span><span class="p">(</span>
            <span class="s2">&quot;Ground motion record&lt;br&gt;&quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span>
            <span class="n">x_vals</span><span class="p">,</span>
            <span class="n">y_vals</span><span class="p">,</span>
            <span class="s2">&quot;line&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.3f&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Absolute Acceleration&quot;</span><span class="p">,</span>
            <span class="n">gmunit</span><span class="p">,</span>
            <span class="s2">&quot;.4f&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acceleration (</span><span class="si">{</span><span class="n">gmunit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="THAnalysis"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.THAnalysis">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">THAnalysis</span><span class="p">(</span><span class="n">GravityPlusAnalysis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dynamic time-history analysis</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">time_vector</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">a_g</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

<div class="viewcode-block" id="THAnalysis.run"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.THAnalysis.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">analysis_time_increment</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">filename_x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">filename_y</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">filename_z</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">file_time_incr</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">finish_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00</span><span class="p">,</span>
        <span class="n">skip_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">damping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="n">print_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the time-history analysis</span>

<span class="sd">        Arguments:</span>
<span class="sd">            filename_x, y, z: Paths where the fixed-step ground acceleration</span>
<span class="sd">                              records are stored (single-column).</span>
<span class="sd">            file_time_incr:   The corresponding time increment</span>
<span class="sd">            finish_time: Specify a target time (s) to stop the analysis</span>
<span class="sd">                         the default value of 0.00 means that it will</span>
<span class="sd">                         run for the entire duration of the files.</span>
<span class="sd">            damping: Can be any of:</span>
<span class="sd">                     {&#39;type&#39;: None},</span>
<span class="sd">                     {&#39;type&#39;: &#39;rayleigh&#39;, &#39;ratio&#39;: r, &#39;periods&#39;: [t1, t2]},</span>
<span class="sd">                     {&#39;type&#39;: &#39;stiffness&#39;, &#39;ratio&#39;: r, &#39;period&#39;: t1}</span>
<span class="sd">                     {&#39;type&#39;: &#39;modal&#39;, &#39;num_modes&#39;: n, &#39;ratio&#39;: r}</span>
<span class="sd">                     {&#39;type&#39;: &#39;modal+stiffness&#39;, &#39;num_modes&#39;: n,</span>
<span class="sd">                     &#39;ratio_modal&#39;: r, &#39;period&#39;: t1,</span>
<span class="sd">                     &#39;ratio_stiffness&#39;: r}</span>
<span class="sd">            print_progress: Controls whether the current time is printed out</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_results</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Running NLTH analysis&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model Name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_all_nodes</span><span class="p">()</span>
        <span class="c1"># note: only runs the first load case provided.</span>
        <span class="c1"># nlth should not have load cases.</span>
        <span class="c1"># will be fixed in the future.</span>
        <span class="n">case_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Case Name: </span><span class="si">{</span><span class="n">case_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_cases</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">parent_nodes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">elastic_elems</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">elm</span>
            <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ElasticBeamColumn</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span>
        <span class="p">]</span>
        <span class="n">disp_elems</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">elm</span>
            <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">DispBeamColumn</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span>
        <span class="p">]</span>
        <span class="n">truss_elems</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">elm</span>
            <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">TrussBar</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">elm</span><span class="o">.</span><span class="n">visibility</span><span class="o">.</span><span class="n">skip_opensees_definition</span>
        <span class="p">]</span>
        <span class="n">line_elems</span> <span class="o">=</span> <span class="n">elastic_elems</span> <span class="o">+</span> <span class="n">disp_elems</span> <span class="o">+</span> <span class="n">truss_elems</span>
        <span class="n">zerolength_elems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">list_of_specific_element</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">ZeroLength</span><span class="p">)</span>

        <span class="n">damping_type</span> <span class="o">=</span> <span class="n">damping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Damping Type: </span><span class="si">{</span><span class="n">damping_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">nss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">filename_x</span><span class="p">:</span>
            <span class="n">gm_vals_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filename_x</span><span class="p">)</span>
            <span class="n">nss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gm_vals_x</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">filename_y</span><span class="p">:</span>
            <span class="n">gm_vals_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filename_y</span><span class="p">)</span>
            <span class="n">nss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gm_vals_y</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">filename_z</span><span class="p">:</span>
            <span class="n">gm_vals_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">filename_z</span><span class="p">)</span>
            <span class="n">nss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gm_vals_z</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filename_x: </span><span class="si">{</span><span class="n">filename_x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filename_y: </span><span class="si">{</span><span class="n">filename_y</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filename_z: </span><span class="si">{</span><span class="n">filename_z</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">num_gm_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nss</span><span class="p">))</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">num_gm_points</span> <span class="o">*</span> <span class="n">file_time_incr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ground Motion Duration: </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> s&#39;</span><span class="p">)</span>

        <span class="n">t_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="mf">0.00</span><span class="p">,</span> <span class="n">file_time_incr</span> <span class="o">*</span> <span class="n">num_gm_points</span><span class="p">,</span> <span class="n">num_gm_points</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">filename_x</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">t_vec</span><span class="p">,</span> <span class="n">gm_vals_x</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">t_vec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_vec</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">filename_y</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">t_vec</span><span class="p">,</span> <span class="n">gm_vals_y</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">t_vec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_vec</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">filename_z</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">t_vec</span><span class="p">,</span> <span class="n">gm_vals_z</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_g</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">t_vec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_vec</span><span class="p">))))</span>

        <span class="k">if</span> <span class="n">finish_time</span> <span class="o">==</span> <span class="mf">0.00</span><span class="p">:</span>
            <span class="n">target_timestamp</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_timestamp</span> <span class="o">=</span> <span class="n">finish_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Defining model in OpenSees&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_to_opensees_domain</span><span class="p">(</span><span class="n">case_name</span><span class="p">)</span>

        <span class="c1"># gravity analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Defining loads&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_define_loads</span><span class="p">(</span><span class="n">case_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Starting gravity analysis (G)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_gravity_analysis</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Gravity analysis finished successfully&quot;</span><span class="p">)</span>
        <span class="n">n_steps_success</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_opensees_results</span><span class="p">(</span>
            <span class="n">case_name</span><span class="p">,</span>
            <span class="n">n_steps_success</span><span class="p">,</span>
            <span class="n">nodes</span><span class="p">,</span>
            <span class="n">line_elems</span><span class="p">,</span>
            <span class="n">zerolength_elems</span><span class="p">,</span>
        <span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Starting transient analysis&quot;</span><span class="p">)</span>

        <span class="n">ops</span><span class="o">.</span><span class="n">wipeAnalysis</span><span class="p">()</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">loadConst</span><span class="p">(</span><span class="s2">&quot;-time&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">curr_time</span> <span class="o">=</span> <span class="mf">0.00</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_time</span><span class="p">)</span>

        <span class="n">ops</span><span class="o">.</span><span class="n">numberer</span><span class="p">(</span><span class="n">NUMBERER</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">constraints</span><span class="p">(</span><span class="o">*</span><span class="n">CONSTRAINTS</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">damping_type</span> <span class="o">==</span> <span class="s2">&quot;rayleigh&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Using Rayleigh damping&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">damping</span><span class="p">[</span><span class="s2">&quot;periods&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">damping</span><span class="p">[</span><span class="s2">&quot;periods&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">w_i</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;periods&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">zeta_i</span> <span class="o">=</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;ratio&quot;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">damping</span><span class="p">[</span><span class="s2">&quot;periods&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">w_j</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;periods&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">zeta_j</span> <span class="o">=</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;ratio&quot;</span><span class="p">]</span>
            <span class="n">a_mat</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">w_i</span><span class="p">,</span> <span class="n">w_i</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">w_j</span><span class="p">,</span> <span class="n">w_j</span><span class="p">]])</span>
            <span class="n">b_vec</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">zeta_i</span><span class="p">,</span> <span class="n">zeta_j</span><span class="p">])</span>
            <span class="n">x_sol</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">a_mat</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b_vec</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">rayleigh</span><span class="p">(</span><span class="n">x_sol</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">x_sol</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># https://portwooddigital.com/2020/11/08/rayleigh-damping-coefficients/</span>
            <span class="c1"># --thanks, prof. Scott</span>

        <span class="k">if</span> <span class="n">damping_type</span> <span class="o">==</span> <span class="s2">&quot;stiffness&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Using stiffness proportional damping&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">damping</span><span class="p">[</span><span class="s2">&quot;ratio&quot;</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">damping</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">rayleigh</span><span class="p">(</span>
                <span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;ratio&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">damping_type</span> <span class="o">==</span> <span class="s2">&quot;modal&quot;</span><span class="p">:</span>
            <span class="c1"># tags = ops.getNodeTags()</span>
            <span class="c1"># num_nodes = len(tags) - 4</span>
            <span class="c1"># num_modeshapes = 3*num_nodes</span>
            <span class="c1"># self.print(len(tags))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Using modal damping&quot;</span><span class="p">)</span>

            <span class="n">num_modes</span> <span class="o">=</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;num_modes&quot;</span><span class="p">]</span>
            <span class="c1"># num_modes = num_modeshapes</span>
            <span class="n">damping_ratio</span> <span class="o">=</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;ratio&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Running eigenvalue analysis&quot;</span> <span class="sa">f</span><span class="s2">&quot; with </span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s2"> modes&quot;</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">eigen</span><span class="p">(</span><span class="n">num_modes</span><span class="p">)</span>
            <span class="c1"># ops.systemSize()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Eigenvalue analysis finished&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">damping_ratio</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">modalDamping</span><span class="p">(</span><span class="n">damping_ratio</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">damping_ratio</span><span class="o">*</span><span class="mf">100.00</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% &quot;</span> <span class="s2">&quot;modal damping defined&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">damping_type</span> <span class="o">==</span> <span class="s2">&quot;modal+stiffness&quot;</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Using modal+stiffness damping&quot;</span><span class="p">)</span>
            <span class="n">num_modes</span> <span class="o">=</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;num_modes&quot;</span><span class="p">]</span>
            <span class="c1"># num_modes = num_modeshapes</span>
            <span class="n">damping_ratio</span> <span class="o">=</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;ratio_modal&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Running eigenvalue analysis&quot;</span> <span class="sa">f</span><span class="s2">&quot; with </span><span class="si">{</span><span class="n">num_modes</span><span class="si">}</span><span class="s2"> modes&quot;</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">eigen</span><span class="p">(</span><span class="n">num_modes</span><span class="p">)</span>
            <span class="c1"># ops.systemSize()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Eigenvalue analysis finished&quot;</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">modalDamping</span><span class="p">(</span><span class="n">damping</span><span class="p">[</span><span class="s2">&quot;ratio_modal&quot;</span><span class="p">])</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">damping</span><span class="p">[</span><span class="s2">&quot;ratio_stiffness&quot;</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">damping</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">ops</span><span class="o">.</span><span class="n">rayleigh</span><span class="p">(</span>
                <span class="mf">0.00</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span>
                <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;ratio_stiffness&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">damping</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;modal+stiffness damping defined&quot;</span><span class="p">)</span>

        <span class="n">ops</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s2">&quot;EnergyIncr&quot;</span><span class="p">,</span> <span class="mf">1.0e-6</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">integrator</span><span class="p">(</span><span class="s1">&#39;Newmark&#39;</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">algorithm</span><span class="p">(</span><span class="s2">&quot;KrylovNewton&quot;</span><span class="p">)</span>
        <span class="n">ops</span><span class="o">.</span><span class="n">analysis</span><span class="p">(</span><span class="s2">&quot;Transient&quot;</span><span class="p">)</span>

        <span class="n">define_lateral_load_pattern</span><span class="p">(</span>
            <span class="n">filename_x</span><span class="p">,</span> <span class="n">filename_y</span><span class="p">,</span> <span class="n">filename_z</span><span class="p">,</span> <span class="n">file_time_incr</span>
        <span class="p">)</span>

        <span class="n">num_subdiv</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">num_times</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_step_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">analysis_failed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">]</span>
        <span class="n">tols</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0e-6</span><span class="p">,</span> <span class="mf">1.0e-6</span><span class="p">,</span> <span class="mf">1.0e-2</span><span class="p">,</span> <span class="mf">1.0e4</span><span class="p">]</span>

        <span class="c1"># progress bar</span>
        <span class="k">if</span> <span class="n">print_progress</span><span class="p">:</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">target_timestamp</span><span class="p">)</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">curr_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pbar</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># store the start time. Used to add log entries on the status</span>
        <span class="c1"># of the analysis every 5 minutes.</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">the_time</span> <span class="o">=</span> <span class="n">start_time</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">while</span> <span class="n">curr_time</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">EPSILON</span> <span class="o">&lt;</span> <span class="n">target_timestamp</span><span class="p">:</span>

                <span class="n">ops</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="s2">&quot;EnergyIncr&quot;</span><span class="p">,</span> <span class="n">tols</span><span class="p">[</span><span class="n">num_subdiv</span><span class="p">],</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">check</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="n">analysis_time_increment</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="n">num_subdiv</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">total_step_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># analysis speed stats</span>
                <span class="k">if</span> <span class="n">check</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># analysis failed</span>
                    <span class="k">if</span> <span class="n">num_subdiv</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># can&#39;t subdivide any further</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;===========================&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Analysis failed to converge&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;===========================&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Analysis failed at time </span><span class="si">{</span><span class="n">curr_time</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="s2">&quot; and cannot continue.&quot;</span>
                            <span class="p">)</span>
                        <span class="n">analysis_failed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

                    <span class="c1"># otherwise, we can still reduce step size</span>
                    <span class="n">num_subdiv</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># how many times to run with reduced step size</span>
                    <span class="n">num_times</span> <span class="o">=</span> <span class="mi">100</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># analysis was successful</span>
                    <span class="n">prev_time</span> <span class="o">=</span> <span class="n">curr_time</span>
                    <span class="n">curr_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ops</span><span class="o">.</span><span class="n">getTime</span><span class="p">())</span>

                    <span class="c1"># progress bar</span>
                    <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">curr_time</span> <span class="o">-</span> <span class="n">prev_time</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
                    <span class="c1"># log entry for analysis status</span>
                    <span class="k">if</span> <span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">the_time</span> <span class="o">&gt;</span> <span class="mf">5.00</span><span class="o">*</span><span class="mf">60.00</span><span class="p">:</span>  <span class="c1"># 5 min</span>
                        <span class="n">the_time</span> <span class="o">=</span> <span class="n">perf_counter</span><span class="p">()</span>
                        <span class="c1"># total time running</span>
                        <span class="n">running_time</span> <span class="o">=</span> <span class="n">the_time</span> <span class="o">-</span> <span class="n">start_time</span>
                        <span class="c1"># nlth seconds ran is `curr_time`</span>
                        <span class="n">remaining_time</span> <span class="o">=</span> <span class="n">target_timestamp</span> <span class="o">-</span> <span class="n">curr_time</span>
                        <span class="n">average_speed</span> <span class="o">=</span> <span class="n">curr_time</span> <span class="o">/</span> <span class="n">running_time</span>  <span class="c1"># nlth [s] / real [s]</span>
                        <span class="c1"># estimated remaining real time to finish [s]</span>
                        <span class="n">est_remaining_dur</span> <span class="o">=</span> <span class="n">remaining_time</span> <span class="o">/</span> <span class="n">average_speed</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Analysis status: </span><span class="se">{{</span><span class="s1">curr: </span><span class="si">{</span><span class="n">curr_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;target: </span><span class="si">{</span><span class="n">target_timestamp</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;num_subdiv: </span><span class="si">{</span><span class="n">num_subdiv</span><span class="si">}</span><span class="s1">, &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;~ </span><span class="si">{</span><span class="n">est_remaining_dur</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> s to finish</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">num_times</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">num_times</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">total_step_count</span> <span class="o">%</span> <span class="n">skip_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">n_steps_success</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_read_opensees_results</span><span class="p">(</span>
                            <span class="n">case_name</span><span class="p">,</span>
                            <span class="n">n_steps_success</span><span class="p">,</span>
                            <span class="n">nodes</span><span class="p">,</span>
                            <span class="n">line_elems</span><span class="p">,</span>
                            <span class="n">zerolength_elems</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">time_vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_time</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">num_subdiv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">num_times</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">num_subdiv</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="n">num_times</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;Analysis interrupted&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Analysis interrupted&quot;</span><span class="p">)</span>

        <span class="c1"># remove the progress bar</span>
        <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Analysis finished&quot;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;successful steps&quot;</span><span class="p">:</span> <span class="n">n_steps_success</span><span class="p">,</span>
            <span class="s2">&quot;analysis_finished_successfully&quot;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">analysis_failed</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">n_steps_success</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_vector</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">pickle_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_results_to_disk</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">metadata</span></div>

<div class="viewcode-block" id="THAnalysis.plot_node_displacement_history"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.THAnalysis.plot_node_displacement_history">[docs]</a>    <span class="k">def</span> <span class="nf">plot_node_displacement_history</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">plotly</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the displacement history of the specified node.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">time_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_vector</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">uid</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">n_steps_success</span><span class="p">):</span>  <span class="c1"># type:ignore</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">vals</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plotly</span><span class="p">:</span>
            <span class="n">general_2d</span><span class="o">.</span><span class="n">line_plot_interactive</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Node </span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s2"> displacement history&quot;</span><span class="p">,</span>
                <span class="n">time_vec</span><span class="p">,</span>
                <span class="n">vals</span><span class="p">,</span>
                <span class="s2">&quot;line&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Time&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s&quot;</span><span class="p">,</span>
                <span class="s2">&quot;.3f&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Rel. Displacement&quot;</span><span class="p">,</span>
                <span class="s2">&quot;in&quot;</span><span class="p">,</span>
                <span class="s2">&quot;.4f&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_vec</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Displacement (in)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ModalResponseSpectrumAnalysis"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.ModalResponseSpectrumAnalysis">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ModalResponseSpectrumAnalysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modal response spectrum analysis.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mdl</span><span class="p">:</span> <span class="n">Model</span>
    <span class="n">load_case</span><span class="p">:</span> <span class="n">LoadCase</span>
    <span class="n">num_modes</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">periods</span><span class="p">:</span> <span class="n">nparr</span>
    <span class="n">spectrum</span><span class="p">:</span> <span class="n">nparr</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">modal_q0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nparr</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">vb_modal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nparr</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">anl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Analysis</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="ModalResponseSpectrumAnalysis.run"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.ModalResponseSpectrumAnalysis.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the modal response spectrum analysis.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spectrum_ifun</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periods</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
        <span class="n">anl</span> <span class="o">=</span> <span class="n">ModalAnalysis</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="p">,</span>
            <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="p">},</span>
            <span class="n">num_modes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">anl</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">pickle_results</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">anl</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_fiber</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">anl</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_forces</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">anl</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">store_reactions</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">anl</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">case_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="o">.</span><span class="n">name</span>
        <span class="n">gammas</span><span class="p">,</span> <span class="n">mstars</span><span class="p">,</span> <span class="n">mtot</span> <span class="o">=</span> <span class="n">anl</span><span class="o">.</span><span class="n">modal_participation_factors</span><span class="p">(</span>
            <span class="n">case_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span>
        <span class="p">)</span>
        <span class="n">periods</span> <span class="o">=</span> <span class="n">anl</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">case_name</span><span class="p">]</span><span class="o">.</span><span class="n">periods</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdl</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">imperial_units</span><span class="p">:</span>
            <span class="n">g_const</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">G_CONST_IMPERIAL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g_const</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">G_CONST_SI</span>
        <span class="n">vb_modal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">)</span>
        <span class="n">modal_q0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">periods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">vb_modal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">spectrum_ifun</span><span class="p">(</span><span class="n">periods</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">*</span> <span class="n">mstars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mtot</span> <span class="o">*</span> <span class="n">g_const</span>
            <span class="p">)</span>
            <span class="n">modal_q0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gammas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">spectrum_ifun</span><span class="p">(</span><span class="n">periods</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">periods</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">*</span> <span class="n">g_const</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modal_q0</span> <span class="o">=</span> <span class="n">modal_q0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vb_modal</span> <span class="o">=</span> <span class="n">vb_modal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anl</span> <span class="o">=</span> <span class="n">anl</span></div>

<div class="viewcode-block" id="ModalResponseSpectrumAnalysis.combined_node_disp"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.ModalResponseSpectrumAnalysis.combined_node_disp">[docs]</a>    <span class="k">def</span> <span class="nf">combined_node_disp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_uid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the SRSS-combined node displacement of a node.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">anl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">modal_q0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anl</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span>
                        <span class="n">node_uid</span>
                    <span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modal_q0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">all_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">all_vals_np</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">all_vals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_vals_np</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModalResponseSpectrumAnalysis.combined_node_disp_diff"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.ModalResponseSpectrumAnalysis.combined_node_disp_diff">[docs]</a>    <span class="k">def</span> <span class="nf">combined_node_disp_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_i_uid</span><span class="p">,</span> <span class="n">node_j_uid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the SRSS-combined displacement difference between two</span>
<span class="sd">        nodes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">anl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">modal_q0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">vals_i</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anl</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span>
                        <span class="n">node_i_uid</span>
                    <span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modal_q0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">modal_q0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">vals_j</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anl</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">node_displacements</span><span class="p">[</span>
                        <span class="n">node_j_uid</span>
                    <span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modal_q0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">vals_i</span> <span class="o">-</span> <span class="n">vals_j</span>
            <span class="n">all_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">all_vals_np</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">all_vals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_vals_np</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModalResponseSpectrumAnalysis.combined_basic_forces"><a class="viewcode-back" href="../../_autosummary/osmg.solver.html#osmg.solver.ModalResponseSpectrumAnalysis.combined_basic_forces">[docs]</a>    <span class="k">def</span> <span class="nf">combined_basic_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_uid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the SRSS-combined basic forces of a line element.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">anl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_modes</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">modal_q0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anl</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_case</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">element_forces</span><span class="p">[</span>
                        <span class="n">element_uid</span>
                    <span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modal_q0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">all_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">all_vals_np</span><span class="p">:</span> <span class="n">nparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">all_vals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">all_vals_np</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">osmg</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks.html">Introductory Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/osmg.html">API reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Ioannis Vouvakis Manousakis.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.1.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>